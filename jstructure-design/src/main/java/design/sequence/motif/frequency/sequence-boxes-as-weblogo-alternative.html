<html>
<head>
    <meta charset="utf-8">
    <title>D3.js Sequence Motif Frequency Heatmap</title>
    <link href="https://fonts.googleapis.com/css?family=Fira+Sans" rel="stylesheet">
    <style>
        html, body {
            font-size: 10px;
            font-family: 'Fira Sans', sans-serif;
        }

        text.month-name,
        text.calendar-heatmap-legend-text,
        text.day-initial {
            font-size: 10px;
            fill: #aaaaaa;
            font-family: 'Fira Sans', sans-serif;
        }
        .day-cell {
            border: 1px solid gray;
        }
        rect.day-cell:hover {
            stroke: #555555;
            stroke-width: 1px;
        }
        .day-cell-tooltip {
            position: absolute;
            z-index: 9999;
            padding: 5px 9px;
            color: #bbbbbb;
            font-size: 12px;
            background: rgba(0, 0, 0, 0.85);
            border-radius: 3px;
            text-align: center;
        }
        .delta {
            display: none;
        }
        .day-cell-tooltip > span {
            font-family: Helvetica, arial, 'Open Sans', sans-serif
        }
        .calendar-heatmap {
            box-sizing: initial;
        }
        .container {
            position: relative;
        }
        body > div {
            display: inline-block;
            /*width: 30%;*/
        }
    </style>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.12.0/moment.min.js" charset="utf-8"></script>
    <script src="https://d3js.org/d3.v3.min.js" charset="utf-8"></script>
</head>
<body>
<div class=""><h3>LY6 cluster 1</h3><div class="container" id="LY6-1"></div></div>
<div class=""><h3>LY6 cluster 2</h3><div class="container" id="LY6-2"></div></div>
<div class=""><h3>LY6 cluster misc</h3><div class="container" id="LY6-misc"></div></div>
<div class=""><h3>GG7 cluster 1</h3><div class="container" id="GG7-1"></div></div>
<div class=""><h3>GG7 cluster 2</h3><div class="container" id="GG7-2"></div></div>
<div class=""><h3>GG7 cluster misc</h3><div class="container" id="GG7-misc"></div></div>
<div class=""><h3>VL4 cluster 1</h3><div class="container" id="VL4-1"></div></div>
<div class=""><h3>VL4 cluster 2</h3><div class="container" id="VL4-2"></div></div>
<div class=""><h3>VL4 cluster misc</h3><div class="container" id="VL4-misc"></div></div>

<script type="text/javascript">
    function calendarHeatmap() {
        var selector = 'body';
        var SQUARE_LENGTH = 11;
        var SQUARE_PADDING = 2;
        var MONTH_LABEL_PADDING = 6;
        var data = [];
        var colorRange = ['#D8E6E7', '#218380'];
        var tooltipEnabled = true;
        var legendEnabled = false;
        var aminoAcids = ["A", "C", "D", "E", "F", "G", "H", "I", "K", "L", "M", "N", "P", "Q", "R", "S", "T", "V", "W", "Y"];
        var width;
        var height;
        <!-- TODO options to show legend, flip chart etc -->

        // setters and getters
        chart.data = function (value) {
            if (!arguments.length) { return data; }
            data = value;
            return chart;
        };

        chart.selector = function (value) {
            if (!arguments.length) { return selector; }
            selector = value;
            return chart;
        };

        chart.colorRange = function (value) {
            if (!arguments.length) { return colorRange; }
            colorRange = value;
            return chart;
        };

        chart.tooltipEnabled = function (value) {
            if (!arguments.length) { return tooltipEnabled; }
            tooltipEnabled = value;
            return chart;
        };

        chart.legendEnabled = function (value) {
            if (!arguments.length) { return legendEnabled; }
            legendEnabled = value;
            return chart;
        };

        function chart() {
            d3.select(chart.selector()).selectAll('svg.calendar-heatmap').remove(); // remove the existing chart, if it exists

            var max = d3.max(chart.data()); // max data value

            // color range
            var color = d3.scale.linear()
                .range(chart.colorRange())
                /* .domain([0, max]); */
                .domain([0, 0.2]);


            var dayRects;

            drawChart();

            function drawChart() {
                <!-- TODO respect legend -->
                var width = 25 + motifPosition(chart.data().length) * (SQUARE_LENGTH + SQUARE_PADDING);
                var height = (aminoAcids.length + 2) *  (SQUARE_LENGTH + SQUARE_PADDING);

                var svg = d3.select(chart.selector())
                    .append('svg')
                    .attr('width', width)
                    .attr('class', 'calendar-heatmap')
                    .attr('height', height);

                dayRects = svg.selectAll('.day-cell')
                    .data(chart.data());

                dayRects.enter().append('rect')
                    .attr('class', 'day-cell')
                    .attr('width', SQUARE_LENGTH)
                    .attr('height', SQUARE_LENGTH)
                    .attr('fill', 'gray')
                    .attr('x', function (d, i) {
                        var result = motifPosition(i);
                        return result * (SQUARE_LENGTH + SQUARE_PADDING) + 25;
                    })
                    .attr('y', function (d, i) {
                        return MONTH_LABEL_PADDING + aminoAcidIndex(i) * (SQUARE_LENGTH + SQUARE_PADDING) + 15;
                    });

                if (chart.tooltipEnabled()) {
                    dayRects.on('mouseover', function (d, i) {
                        tooltip = d3.select(chart.selector())
                            .append('div')
                            .attr('class', 'day-cell-tooltip')
                            .html('<strong>' + aminoAcids[aminoAcidIndex(i)] + '</strong> frequency at postition <strong>' + (motifPosition(i) + 1) + '</strong>: <strong>' + round2Fixed(d) + '</strong>')
                            .style('left', function () { return -20 + motifPosition(i) * SQUARE_LENGTH + 'px'; })
                            .style('top', function () {
                                return -25 + aminoAcidIndex(i) * (SQUARE_LENGTH + SQUARE_PADDING) + MONTH_LABEL_PADDING * 3 + 'px';
                            });
                    }).on('mouseout', function (d, i) {
                        tooltip.remove();
                    });
                }

                if (chart.legendEnabled()) {
                    var colorRange = [color(0)];
                    for (var i = 1; i <= 4; i++) {
                        colorRange.push(color(max / i));
                    }

                    var legendGroup = svg.append('g');
                    legendGroup.selectAll('.calendar-heatmap-legend')
                        .data(colorRange)
                        .enter()
                        .append('rect')
                        .attr('class', 'calendar-heatmap-legend')
                        .attr('width', SQUARE_LENGTH)
                        .attr('height', SQUARE_LENGTH)
                        .attr('x', width - SQUARE_LENGTH)
                        .attr('y', function (d, i) { return 30 + (i + 1) * 13; })
                        .attr('fill', function (d) { return d; });

                    legendGroup.append('text')
                        .attr('class', 'calendar-heatmap-legend-text')
                        .attr('x', width - SQUARE_LENGTH)
                        .attr('y', height - 2 * SQUARE_LENGTH)
                        .text('Rare');

                    legendGroup.append('text')
                        .attr('class', 'calendar-heatmap-legend-text')
                        .attr('x', width - SQUARE_LENGTH)
                        .attr('y', height - 2 * SQUARE_LENGTH)
                        .text('Common');
                }

                // amino acid labels
                aminoAcids.forEach(function (aminoAcid, index) {
                    svg.append('text')
                        .attr('class', 'day-initial')
                        .attr('transform', 'translate(10,' + (15 + (SQUARE_LENGTH + SQUARE_PADDING) * (index + 1)) + ')')
                        .style('text-anchor', 'middle')
                        .attr('dy', '2')
                        .text(aminoAcid);
                });

                // sequence motif positions
                for (var i = 1; i <= motifPosition(chart.data().length); i++) {
                    svg.append('text')
                        .attr('class', 'day-initial')
                        .attr('transform', 'translate(' + (17 + (SQUARE_LENGTH + SQUARE_PADDING) * i) + ',10)')
                        .style('text-anchor', 'middle')
                        .attr('dy', '2')
                        .text(i);
                }
            }

            function aminoAcidIndex(d) {
                return d % aminoAcids.length;
            }

            function motifPosition(d) {
                return Math.floor(d / aminoAcids.length);
            }

            function round2Fixed(value) {
                value = +value;

                if (isNaN(value))
                    return NaN;

                value = value.toString().split('e');
                value = Math.round(+(value[0] + 'e' + (value[1] ? (+value[1] + 2) : 2)));

                value = value.toString().split('e');
                return (+(value[0] + 'e' + (value[1] ? (+value[1] - 2) : -2))).toFixed(2);
            }

            // set color to rects
            dayRects.attr('fill', function (d, i) {
                return color(chart.data()[i]);
            });
        }

        return chart;
    }

</script>

<script type="text/javascript">
    var fLY61 = calendarHeatmap().data([0.0597,0.0000,0.0000,0.0075,0.0970,0.0896,0.0224,0.2015,0.0373,0.1791,0.0522,0.0000,0.0149,0.0149,0.0299,0.0149,0.0448,0.0821,0.0448,0.0075,0.2015,0.0000,0.0000,0.0149,0.2239,0.1119,0.0000,0.0522,0.0000,0.1045,0.0075,0.0075,0.0000,0.0000,0.0224,0.0597,0.0672,0.1119,0.0149,0.0000,0.0896,0.0075,0.0000,0.0149,0.1343,0.0522,0.0075,0.1493,0.0000,0.2164,0.0075,0.0373,0.0299,0.0000,0.0149,0.0149,0.0149,0.1716,0.0373,0.0000,0.0896,0.0299,0.0075,0.0075,0.1045,0.0522,0.0149,0.1418,0.0149,0.2313,0.0224,0.0149,0.0000,0.0000,0.0224,0.1119,0.0373,0.0746,0.0075,0.0149,0.0896,0.0373,0.0000,0.0000,0.0896,0.1343,0.0000,0.0522,0.0000,0.2239,0.0448,0.0224,0.0000,0.0000,0.0075,0.0224,0.0373,0.1940,0.0299,0.0149]).selector('#LY6-1').colorRange(['#f4f7f7', '#79a8a9']); fLY61();
    var fLY62 = calendarHeatmap().data([0.0395,0.0263,0.0000,0.0000,0.0658,0.1447,0.0395,0.0658,0.0000,0.2763,0.0789,0.0000,0.0000,0.0000,0.0000,0.0658,0.0658,0.0789,0.0132,0.0395,0.0526,0.0000,0.0132,0.0132,0.0789,0.0395,0.0000,0.0263,0.0000,0.1842,0.1316,0.0132,0.0395,0.0000,0.0000,0.0526,0.1316,0.1579,0.0000,0.0658,0.1974,0.0000,0.0000,0.0000,0.0658,0.0921,0.0263,0.1316,0.0000,0.2237,0.0000,0.0000,0.0000,0.0000,0.0000,0.0658,0.0395,0.0658,0.0921,0.0000,0.0921,0.0132,0.0000,0.0132,0.1184,0.1316,0.0395,0.1579,0.0395,0.2500,0.0263,0.0000,0.0132,0.0000,0.0000,0.0263,0.0132,0.0526,0.0132,0.0000,0.1579,0.0526,0.0132,0.0526,0.1447,0.0526,0.0000,0.1184,0.0000,0.0789,0.0263,0.0132,0.0000,0.0395,0.0000,0.0132,0.1053,0.1184,0.0000,0.0132]).selector('#LY6-2').colorRange(['#f4f7f7', '#79a8a9']); fLY62();
    var fLY6misc = calendarHeatmap().data([0.1802,0.0180,0.0360,0.0090,0.0631,0.1171,0.0360,0.0270,0.0270,0.1441,0.0541,0.0270,0.0090,0.0000,0.0270,0.0811,0.0360,0.0721,0.0360,0.0000,0.0721,0.0090,0.0270,0.0090,0.0901,0.0721,0.0000,0.0811,0.0180,0.1802,0.0631,0.0000,0.0360,0.0180,0.0090,0.0901,0.0631,0.1351,0.0000,0.0270,0.0901,0.0000,0.0000,0.0090,0.1081,0.0631,0.0000,0.1532,0.0000,0.1532,0.0270,0.0180,0.0270,0.0090,0.0180,0.1261,0.0450,0.0721,0.0721,0.0090,0.1081,0.0000,0.0090,0.0180,0.1351,0.1351,0.0360,0.1802,0.0000,0.1081,0.0541,0.0090,0.0270,0.0000,0.0000,0.0541,0.0450,0.0811,0.0000,0.0000,0.0360,0.0450,0.0180,0.0270,0.0360,0.1802,0.0090,0.0901,0.0270,0.1441,0.0180,0.0541,0.0360,0.0180,0.0000,0.1532,0.0180,0.0631,0.0000,0.0270]).selector('#LY6-misc').colorRange(['#f4f7f7', '#79a8a9']); fLY6misc();
    var fGG71 = calendarHeatmap().data([0.0730,0.0000,0.0219,0.0584,0.1606,0.0219,0.0073,0.0365,0.1095,0.0730,0.0073,0.0584,0.0365,0.1168,0.0146,0.0219,0.0292,0.0949,0.0438,0.0146,0.1022,0.0073,0.0511,0.0073,0.0511,0.0876,0.0146,0.1825,0.0073,0.2044,0.0000,0.0000,0.0146,0.0438,0.0292,0.0511,0.0292,0.0657,0.0292,0.0219,0.2555,0.0000,0.0219,0.0000,0.0511,0.1533,0.0073,0.0365,0.0000,0.0876,0.0657,0.0219,0.0365,0.1022,0.0219,0.0292,0.0438,0.0219,0.0219,0.0219,0.1241,0.0000,0.0219,0.1095,0.0730,0.0365,0.0146,0.1095,0.0000,0.2117,0.0146,0.0146,0.0219,0.1022,0.0365,0.0146,0.0292,0.0365,0.0146,0.0146,0.2117,0.0000,0.0146,0.0146,0.0438,0.1241,0.0146,0.0438,0.0219,0.1314,0.0511,0.0073,0.0073,0.0073,0.0365,0.0292,0.0073,0.0511,0.0219,0.1606,0.1606,0.0073,0.0000,0.0000,0.0730,0.0292,0.0073,0.1314,0.0438,0.2263,0.0584,0.0292,0.0000,0.0000,0.0073,0.0146,0.0584,0.1241,0.0146,0.0146]).selector('#GG7-1').colorRange(['#f4f7f7', '#79a8a9']); fGG71();
    var fGG72 = calendarHeatmap().data([0.2105,0.0000,0.0000,0.0000,0.1053,0.0000,0.0000,0.0000,0.0000,0.1579,0.0526,0.0526,0.1053,0.0526,0.0000,0.0526,0.0000,0.1053,0.0526,0.0526,0.1053,0.0000,0.0000,0.0000,0.0526,0.0000,0.0000,0.0526,0.1053,0.3158,0.1053,0.0000,0.0000,0.0000,0.0000,0.1579,0.0526,0.0526,0.0000,0.0000,0.1053,0.0000,0.1053,0.0526,0.0000,0.0526,0.0000,0.0000,0.0000,0.1053,0.0000,0.0000,0.0000,0.0000,0.0000,0.2105,0.0000,0.3158,0.0000,0.0526,0.2632,0.0000,0.3158,0.0526,0.0000,0.0000,0.0000,0.0000,0.0000,0.0526,0.0000,0.0526,0.0000,0.0000,0.1053,0.0000,0.0000,0.0000,0.1579,0.0000,0.1053,0.0000,0.0000,0.0000,0.1053,0.0000,0.0000,0.0000,0.1053,0.1579,0.0526,0.0000,0.0000,0.0000,0.2105,0.0526,0.1053,0.1053,0.0000,0.0000,0.1053,0.0000,0.0000,0.0000,0.1579,0.1053,0.0526,0.2105,0.0526,0.1579,0.0000,0.0000,0.0000,0.0000,0.0000,0.1053,0.0526,0.0000,0.0000,0.0000]).selector('#GG7-2').colorRange(['#f4f7f7', '#79a8a9']); fGG72();
    var fGG7misc = calendarHeatmap().data([0.0833,0.0278,0.0347,0.0069,0.0694,0.1528,0.0417,0.0625,0.0347,0.1319,0.0417,0.0000,0.0208,0.0278,0.0208,0.0903,0.0694,0.0694,0.0000,0.0139,0.1319,0.0000,0.0694,0.0208,0.0208,0.0764,0.0208,0.1042,0.0625,0.1528,0.0278,0.0139,0.0625,0.0278,0.0208,0.0486,0.0417,0.0694,0.0069,0.0208,0.1111,0.0069,0.0625,0.0347,0.0139,0.1806,0.0347,0.0347,0.0208,0.1181,0.0069,0.0486,0.0278,0.0069,0.0347,0.0347,0.0208,0.0764,0.0556,0.0694,0.1458,0.0000,0.0000,0.0278,0.0556,0.0972,0.0347,0.0139,0.0347,0.0972,0.0486,0.0417,0.0486,0.0208,0.0694,0.0625,0.1181,0.0347,0.0069,0.0417,0.1319,0.0000,0.0139,0.0069,0.0347,0.0833,0.0139,0.0625,0.0069,0.0903,0.0069,0.0347,0.0972,0.0000,0.0972,0.0625,0.0417,0.0694,0.0972,0.0486,0.0764,0.0069,0.0417,0.0417,0.0417,0.0833,0.0139,0.0903,0.0139,0.1042,0.0139,0.0069,0.0347,0.0139,0.0139,0.0556,0.1111,0.1250,0.0000,0.1111]).selector('#GG7-misc').colorRange(['#f4f7f7', '#79a8a9']); fGG7misc();
    var fVL41 = calendarHeatmap().data([0.1214,0.0643,0.0357,0.0786,0.0214,0.1000,0.0143,0.0714,0.0214,0.0786,0.0286,0.0000,0.0286,0.0429,0.1071,0.0357,0.0500,0.0714,0.0071,0.0214,0.0929,0.0143,0.0071,0.0071,0.0929,0.0429,0.0071,0.0500,0.0357,0.1357,0.0357,0.0500,0.0214,0.0571,0.0714,0.0214,0.0429,0.0286,0.0500,0.1357,0.1286,0.0071,0.0214,0.0071,0.0214,0.0643,0.0071,0.0143,0.0214,0.1500,0.0357,0.0214,0.0429,0.0143,0.0500,0.1714,0.0214,0.1000,0.0286,0.0714]).selector('#VL4-1').colorRange(['#f4f7f7', '#79a8a9']); fVL41();
    var fVL42 = calendarHeatmap().data([0.0000,0.0000,0.0000,0.0000,0.0000,0.5000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.5000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,1.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.0000,0.5000,0.0000,0.0000,0.0000,0.0000,0.5000,0.0000,0.0000,0.0000,0.0000,0.0000]).selector('#VL4-2').colorRange(['#f4f7f7', '#79a8a9']); fVL42();
    var fVL4misc = calendarHeatmap().data([0.0746,0.0000,0.0149,0.0000,0.0149,0.0149,0.0000,0.0746,0.0149,0.0896,0.0000,0.1045,0.0746,0.0597,0.1194,0.2090,0.0448,0.0299,0.0000,0.0597,0.0746,0.0149,0.1194,0.0448,0.0299,0.0149,0.0000,0.0746,0.0299,0.1194,0.0597,0.0597,0.1493,0.0299,0.0597,0.0000,0.0448,0.0149,0.0299,0.0299,0.0299,0.0000,0.0299,0.0746,0.1045,0.1194,0.0299,0.0597,0.0746,0.0746,0.0149,0.0149,0.0746,0.0299,0.0448,0.0448,0.1343,0.0000,0.0448,0.0000]).selector('#VL4-misc').colorRange(['#f4f7f7', '#79a8a9']); fVL4misc();

</script>
</body>
</html>